<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pre-Compiled CmdStan Models in R Packages • instantiate</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="Pre-Compiled CmdStan Models in R Packages">
<meta property="og:description" content="Similar to rstantools for rstan, the instantiate package builds pre-compiled CmdStan models into CRAN-ready statistical modeling R packages. The models compile once during installation, the executables live inside the file systems of their respective packages, and users have the full power and convenience of cmdstanr without any additional compilation after package installation. This approach saves time and helps R package developers migrate from rstan to the more modern cmdstanr. Packages rstantools, cmdstanr, stannis, and stanapi are similar Stan clients with different objectives.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">instantiate</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.2.3.9002</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="reference/index.html">Reference</a>
</li>
<li>
  <a href="news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/wlandau/instantiate/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="contents col-md-9">

<div class="section level1">
<div class="page-header"><h1 id="instantiate-pre-compiled-cmdstan-models-in-r-packages">instantiate: pre-compiled CmdStan models in R packages<a class="anchor" aria-label="anchor" href="#instantiate-pre-compiled-cmdstan-models-in-r-packages"></a>
</h1></div>
<p><a href="https://CRAN.R-project.org/package=instantiate" class="external-link"><img src="https://www.r-pkg.org/badges/version/instantiate" alt="CRAN"></a> <a href="https://www.repostatus.org/#active" class="external-link"><img src="https://www.repostatus.org/badges/latest/active.svg" alt="status"></a> <a href="https://github.com/wlandau/instantiate/actions?query=workflow%3Acheck-cmdstanr" class="external-link"><img src="https://github.com/wlandau/instantiate/workflows/check-cmdstanr/badge.svg" alt="check-cmdstanr"></a> <a href="https://github.com/wlandau/instantiate/actions?query=workflow%3Acheck-cran" class="external-link"><img src="https://github.com/wlandau/instantiate/workflows/check-cran/badge.svg" alt="check-cran"></a> <a href="https://github.com/wlandau/instantiate/actions?query=workflow%3Acheck-fixed" class="external-link"><img src="https://github.com/wlandau/instantiate/workflows/check-fixed/badge.svg" alt="check-fixed"></a> <a href="https://app.codecov.io/gh/wlandau/instantiate" class="external-link"><img src="https://codecov.io/gh/wlandau/instantiate/branch/main/graph/badge.svg" alt="codecov"></a> <a href="https://github.com/wlandau/instantiate/actions?query=workflow%3Alint" class="external-link"><img src="https://github.com/wlandau/instantiate/workflows/lint/badge.svg" alt="lint"></a></p>
<p>Similar to <a href="https://mc-stan.org/rstantools/" class="external-link"><code>rstantools</code></a> for <a href="https://mc-stan.org/rstan/" class="external-link"><code>rstan</code></a>, the <code>instantiate</code> package builds pre-compiled <a href="https://mc-stan.org/users/interfaces/cmdstan" class="external-link"><code>CmdStan</code></a> models into CRAN-ready statistical modeling R packages. The models compile once during installation, the executables live inside the file systems of their respective packages, and users have the full power and convenience of <a href="https://mc-stan.org/cmdstanr/" class="external-link"><code>CmdStanR</code></a> without any additional compilation after package installation. This approach saves time and helps R package developers migrate from <a href="https://mc-stan.org/rstan/" class="external-link"><code>rstan</code></a> to the more modern <a href="https://mc-stan.org/cmdstanr/" class="external-link"><code>CmdStanR</code></a>.</p>
</div>
<div class="section level1">
<h1 id="documentation">Documentation<a class="anchor" aria-label="anchor" href="#documentation"></a>
</h1>
<p>The website at <a href="https://wlandau.github.io/instantiate/" class="external-link uri">https://wlandau.github.io/instantiate/</a> includes a <a href="https://wlandau.github.io/instantiate/reference/index.html" class="external-link">function reference</a> and other documentation.</p>
</div>
<div class="section level1">
<h1 id="installing-instantiate">Installing <code>instantiate</code>
<a class="anchor" aria-label="anchor" href="#installing-instantiate"></a>
</h1>
<p>The <code>instantiate</code> package depends on the R package <a href="https://mc-stan.org/cmdstanr/" class="external-link"><code>CmdStanR</code></a> and the command line tool <a href="https://mc-stan.org/users/interfaces/cmdstan" class="external-link"><code>CmdStan</code></a>, so it is important to follow these stages in order:</p>
<ol style="list-style-type: decimal">
<li>Install the R package <a href="https://mc-stan.org/cmdstanr/" class="external-link"><code>CmdStanR</code></a>. <a href="https://mc-stan.org/cmdstanr/" class="external-link"><code>CmdStanR</code></a> is not on CRAN, so the recommended way to install it is <code>install.packages("cmdstanr", repos = c("https://mc-stan.org/r-packages/", getOption("repos")))</code>.</li>
<li>Optional: set environment variables <code>CMDSTAN_INSTALL</code> and/or <code>CMDSTAN</code> to manage the <a href="https://mc-stan.org/users/interfaces/cmdstan" class="external-link"><code>CmdStan</code></a> installation. See the “Administering CmdStan” section below for details.</li>
<li>Install <code>instantiate</code> using one of the R commands below.</li>
</ol>
<table class="table">
<colgroup>
<col width="33%">
<col width="33%">
<col width="33%">
</colgroup>
<thead><tr class="header">
<th>Type</th>
<th>Source</th>
<th>Command</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Release</td>
<td>CRAN</td>
<td><code>install.packages("instantiate")</code></td>
</tr>
<tr class="even">
<td>Development</td>
<td>GitHub</td>
<td><code>remotes::install_github("wlandau/instantiate")</code></td>
</tr>
<tr class="odd">
<td>Development</td>
<td>R-universe</td>
<td><code>install.packages("instantiate", repos = "https://wlandau.r-universe.dev")</code></td>
</tr>
</tbody>
</table>
</div>
<div class="section level1">
<h1 id="installing-packages-that-use-instantiate">Installing packages that use <code>instantiate</code>
<a class="anchor" aria-label="anchor" href="#installing-packages-that-use-instantiate"></a>
</h1>
<p>Packages that use <code>instantiate</code> may be published on CRAN. CRAN does not have <code>CmdStan</code>, so the models are not pre-compiled in the Mac OS and Windows binaries. If you install from CRAN, please install from the source. For example:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"hdbayes"</span>, type <span class="op">=</span> <span class="st">"source"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level1">
<h1 id="environment-variables">Environment variables<a class="anchor" aria-label="anchor" href="#environment-variables"></a>
</h1>
<p>The <code>instantiate</code> package uses environment variables to manage the installation of <a href="https://mc-stan.org/users/interfaces/cmdstan" class="external-link"><code>CmdStan</code></a>. An environment variable is an operating system setting with a name and a value (both text strings). In R, there are two ways to set environment variables:</p>
<ol style="list-style-type: decimal">
<li>
<code><a href="https://rdrr.io/r/base/Sys.setenv.html" class="external-link">Sys.setenv()</a></code>, which sets environment variables temporarily for the current R session.</li>
<li>The <code>.Renviron</code> text file in you home directory, which passes environment variables to all new R sessions. the <a href="https://usethis.r-lib.org/reference/edit.html" class="external-link"><code>edit_r_environ()</code></a> function from the <a href="https://usethis.r-lib.org/" class="external-link"><code>usethis</code></a> package helps.</li>
</ol>
</div>
<div class="section level1">
<h1 id="administering-cmdstan">Administering CmdStan<a class="anchor" aria-label="anchor" href="#administering-cmdstan"></a>
</h1>
<p>By default, <code>instantiate</code> looks for the copy of <a href="https://mc-stan.org/users/interfaces/cmdstan" class="external-link"><code>CmdStan</code></a> located at <code><a href="https://mc-stan.org/cmdstanr/reference/install_cmdstan.html" class="external-link">cmdstanr::install_cmdstan()</a></code>. If you upgrade <a href="https://mc-stan.org/users/interfaces/cmdstan" class="external-link"><code>CmdStan</code></a>, then the path returned by <code><a href="https://mc-stan.org/cmdstanr/reference/install_cmdstan.html" class="external-link">cmdstanr::install_cmdstan()</a></code> will change, which may not be desirable in some cases. To permanently lock the path that <code>instantiate</code> uses, follow these steps:</p>
<ol style="list-style-type: decimal">
<li>Set the <code>CMDSTAN</code> environment variable to the desired path to <a href="https://mc-stan.org/users/interfaces/cmdstan" class="external-link"><code>CmdStan</code></a>.</li>
<li>Set the <code>CMDSTAN_INSTALL</code> environment variable to <code>"fixed"</code>.</li>
<li>Install <code>instantiate</code>.</li>
</ol>
<p>Henceforth, <code>instantiate</code> will automatically use the <a href="https://mc-stan.org/users/interfaces/cmdstan" class="external-link"><code>CmdStan</code></a> path from (1), regardless of the value of <code>CMDSTAN</code> after (3). To prefer <code><a href="https://mc-stan.org/cmdstanr/reference/set_cmdstan_path.html" class="external-link">cmdstanr::cmdstan_path()</a></code> instead, you could do one of the following:</p>
<ul>
<li>Reinstall <code>instantiate</code> with <code>CMDSTAN_INSTALL</code> not equal to <code>"fixed"</code>, or</li>
<li>Set <code>CMDSTAN_INSTALL</code> to <code>"implicit"</code> at runtime, or</li>
<li>Set the <code>cmdstan_install</code> argument to <code>"implicit"</code> for the current <code>instantiate</code> package function you are using.</li>
</ul>
</div>
<div class="section level1">
<h1 id="packaging-stan-models">Packaging Stan models<a class="anchor" aria-label="anchor" href="#packaging-stan-models"></a>
</h1>
<p>The following section explains how to create an R package with pre-compiled Stan models. This stage of the development workflow is considered “runtime” for the purposes of administering <a href="https://mc-stan.org/users/interfaces/cmdstan" class="external-link"><code>CmdStan</code></a> as described previously.</p>
<div class="section level2">
<h2 id="structure">Structure<a class="anchor" aria-label="anchor" href="#structure"></a>
</h2>
<p>Begin with an R package with one or more Stan model files inside the <code>src/stan/</code> directory. <code><a href="reference/stan_package_create.html">stan_package_create()</a></code> is a convenient way to start.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/stan_package_create.html">stan_package_create</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"package_folder"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Example package named "example" created at "package_folder". Run stan_package_configure(path = "package_folder") so that the built-in Stan model will compile when the package installs.</span></span></code></pre></div>
<p>At minimum the package file structure should look something like this:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/dir_tree.html" class="external-link">dir_tree</a></span><span class="op">(</span><span class="st">"package_folder"</span><span class="op">)</span></span>
<span><span class="co">#&gt; package_folder</span></span>
<span><span class="co">#&gt; ├── DESCRIPTION</span></span>
<span><span class="co">#&gt; └── src</span></span>
<span><span class="co">#&gt;     └── stan</span></span>
<span><span class="co">#&gt;         └── bernoulli.stan</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="configuration">Configuration<a class="anchor" aria-label="anchor" href="#configuration"></a>
</h2>
<p>Configure the package so the Stan models compile during installation. <code><a href="reference/stan_package_configure.html">stan_package_configure()</a></code> writes required scripts <code>cleanup</code>, <code>cleanup.win</code>, <code>src/Makevars</code>, <code>src/Makevars.win</code>, and <code>src/install.libs.R</code>. Inside <code>src/install.libs.R</code> is a call to <code><a href="reference/stan_package_compile.html">instantiate::stan_package_compile()</a></code> which you can manually edit to control how your models are compiled. For example, different calls to <code><a href="reference/stan_package_compile.html">stan_package_compile()</a></code> can compile different groups of models using different C++ compiler flags.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/dir_tree.html" class="external-link">dir_tree</a></span><span class="op">(</span><span class="st">"package_folder"</span><span class="op">)</span></span>
<span><span class="co">#&gt; package_folder</span></span>
<span><span class="co">#&gt; ├── DESCRIPTION</span></span>
<span><span class="co">#&gt; ├── cleanup</span></span>
<span><span class="co">#&gt; ├── cleanup.win</span></span>
<span><span class="co">#&gt; └── src</span></span>
<span><span class="co">#&gt;     ├── Makevars</span></span>
<span><span class="co">#&gt;     ├── Makevars.win</span></span>
<span><span class="co">#&gt;     ├── install.libs.R</span></span>
<span><span class="co">#&gt;     └── stan</span></span>
<span><span class="co">#&gt;         └── bernoulli.stan</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>Install the package just like you would any other R package. To install it from your local copy of <code>package_folder</code>, open R and run:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span>pkgs <span class="op">=</span> <span class="st">"package_folder"</span>, type <span class="op">=</span> <span class="st">"source"</span>, repos <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="models">Models<a class="anchor" aria-label="anchor" href="#models"></a>
</h2>
<p>A user can now run a model from the package without any additional compilation. See the documentation of <a href="https://mc-stan.org/cmdstanr/index.html" class="external-link"><code>CmdStanR</code></a> to learn how to use <a href="https://mc-stan.org/cmdstanr/index.html" class="external-link"><code>CmdStanR</code></a> model objects.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">example</span><span class="op">)</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/stan_package_model.html">stan_package_model</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"bernoulli"</span>, package <span class="op">=</span> <span class="st">"example"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span> <span class="co"># CmdStanR model object</span></span>
<span><span class="co">#&gt; data {</span></span>
<span><span class="co">#&gt;   int&lt;lower=0&gt; N;</span></span>
<span><span class="co">#&gt;   array[N] int&lt;lower=0,upper=1&gt; y;</span></span>
<span><span class="co">#&gt; }</span></span>
<span><span class="co">#&gt; parameters {</span></span>
<span><span class="co">#&gt;   real&lt;lower=0,upper=1&gt; theta;</span></span>
<span><span class="co">#&gt; }</span></span>
<span><span class="co">#&gt; model {</span></span>
<span><span class="co">#&gt;   theta ~ beta(1,1);  // uniform prior on interval 0,1</span></span>
<span><span class="co">#&gt;   y ~ bernoulli(theta);</span></span>
<span><span class="co">#&gt; }</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="va">model</span><span class="op">$</span><span class="fu">sample</span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>N <span class="op">=</span> <span class="fl">10</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  refresh <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  iter_warmup <span class="op">=</span> <span class="fl">2000</span>,</span>
<span>  iter_sampling <span class="op">=</span> <span class="fl">4000</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Running MCMC with 4 sequential chains...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Chain 1 finished in 0.0 seconds.</span></span>
<span><span class="co">#&gt; Chain 2 finished in 0.0 seconds.</span></span>
<span><span class="co">#&gt; Chain 3 finished in 0.0 seconds.</span></span>
<span><span class="co">#&gt; Chain 4 finished in 0.0 seconds.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; All 4 chains finished successfully.</span></span>
<span><span class="co">#&gt; Mean chain execution time: 0.0 seconds.</span></span>
<span><span class="co">#&gt; Total execution time: 0.6 seconds.</span></span>
<span></span>
<span><span class="va">fit</span><span class="op">$</span><span class="fu">summary</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 10</span></span>
<span><span class="co">#&gt;   variable   mean median    sd   mad     q5    q95  rhat ess_bulk ess_tail</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;     &lt;num&gt;  &lt;num&gt; &lt;num&gt; &lt;num&gt;  &lt;num&gt;  &lt;num&gt; &lt;num&gt;    &lt;num&gt;    &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1 lp__     -8.15  -7.87  0.725 0.317 -9.60  -7.64   1.00    7365.    8498.</span></span>
<span><span class="co">#&gt; 2 theta     0.333  0.324 0.130 0.134  0.137  0.563  1.00    6229.    7560.</span></span></code></pre></div>
<p>You can write an exported user-side function in your R package to access the model. For example, you might store this code in a <code>R/model.R</code> file in the package:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @title Fit the Bernoulli model.</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="co">#' @family models</span></span>
<span><span class="co">#' @description Fit the Bernoulli Stan model and return posterior summaries.</span></span>
<span><span class="co">#' @return A data frame of posterior summaries.</span></span>
<span><span class="co">#' @param y Numeric vector of Bernoulli observations (zeroes and ones).</span></span>
<span><span class="co">#' @param `...` Named arguments to the `sample()` method of CmdStan model</span></span>
<span><span class="co">#'   objects: &lt;https://mc-stan.org/cmdstanr/reference/model-method-sample.html&gt;</span></span>
<span><span class="co">#' @examples</span></span>
<span><span class="co">#' if (instantiate::stan_cmdstan_exists()) {</span></span>
<span><span class="co">#'   run_bernoulli_model(y = c(1, 0, 1, 0, 1, 0, 0, 0, 0, 0))</span></span>
<span><span class="co">#' }</span></span>
<span><span class="va">run_bernoulli_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">is.numeric</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="va">y</span> <span class="op">&gt;=</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">y</span> <span class="op">&lt;=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/stan_package_model.html">stan_package_model</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"bernoulli"</span>, package <span class="op">=</span> <span class="st">"mypackage"</span><span class="op">)</span></span>
<span>  <span class="va">fit</span> <span class="op">&lt;-</span> <span class="va">model</span><span class="op">$</span><span class="fu">sample</span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>N <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span>, <span class="va">...</span><span class="op">)</span></span>
<span>  <span class="va">fit</span><span class="op">$</span><span class="fu">summary</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="development">Development<a class="anchor" aria-label="anchor" href="#development"></a>
</h2>
<ol style="list-style-type: decimal">
<li>In your package <code>DESCRIPTION</code> file, list <a href="https://mc-stan.org/r-packages/" class="external-link uri">https://mc-stan.org/r-packages/</a> in the <code>Additional_repositories:</code> field (<a href="https://github.com/paul-buerkner/brms/blob/5c09251daabd5416e3d47004cc6c62816dc53cfa/DESCRIPTION#L95-L96" class="external-link">example in <code>brms</code></a>). This step is only necessary while <a href="https://mc-stan.org/cmdstanr/" class="external-link"><code>cmdstanr</code></a> is not yet on CRAN.</li>
</ol>
<!-- --><div class="sourceCode" id="cb8"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>Additional_repositories<span class="sc">:</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>    https<span class="sc">:</span><span class="er">//</span>mc<span class="sc">-</span>stan.org<span class="sc">/</span>r<span class="sc">-</span>packages<span class="sc">/</span></span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>In your package <code>DESCRIPTION</code> and <code>NAMESPACE</code> files, import the <code>instantiate</code> package and function <code><a href="reference/stan_package_model.html">stan_package_model()</a></code>.</li>
<li>Write user-side statistical modeling functions which call the models in your package as mentioned above.</li>
<li>
<a href="https://mc-stan.org/users/interfaces/cmdstan" class="external-link"><code>CmdStan</code></a> is too big for <a href="https://cran.r-project.org" class="external-link">CRAN</a>, so <code>instantiate</code> will not be able to access it there. So if you plan to submit your package to CRAN, please skip the appropriate code in your examples, vignettes, and tests when <code><a href="reference/stan_cmdstan_exists.html">instantiate::stan_cmdstan_exists()</a></code> is <code>FALSE</code>. Explicit <code>if()</code> statements like the above one in the <a href="https://roxygen2.r-lib.org/" class="external-link"><code>roxygen2</code></a> <code>@examples</code> work for examples and vignettes. For tests, it is convenient to use <a href="https://testthat.r-lib.org/reference/skip.html" class="external-link"><code>testthat::skip_if_not()</code></a>, e.g. <code>skip_if_not(stan_cmdstan_exists())</code>.</li>
<li>
<a href="https://pkgload.r-lib.org/reference/load_all.html" class="external-link"><code>pkgload::load_all()</code></a> is not compatible with <code>instantiate</code>. This is because <code>instantiate</code> relies on a custom <code>src/install.libs.R</code> script to compile the models, and <code>load_all()</code> does not pick up custom binaries compiled this way. That means <code>devtools::test()</code> may not work as expected. Please install your package the standard way, then test with alternative means such as <code>devtools::check()</code>, <code>R CMD check</code>, or <code>tinytest</code>.</li>
<li>For <a href="https://git-scm.com/book/en/v2/Getting-Started-About-Version-Control" class="external-link">version control</a>, it is best practice to commit only source code files and documentation. Please do not commit any compiled executable Stan model files to your repository. If you do commit them, then other users with different machines will have trouble installing your package, and your commit history will consume too much storage. For <a href="https://git-scm.com" class="external-link">Git</a>, you may add the following lines to the <a href="https://git-scm.com/docs/gitignore" class="external-link"><code>.gitigore</code></a> file at the root of your package:</li>
</ol>
<!-- --><div class="sourceCode" id="cb9"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>src<span class="sc">/</span>stan<span class="sc">/</span><span class="er">**</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="sc">!</span>src<span class="sc">/</span>stan<span class="sc">/</span><span class="er">**/*</span>.<span class="sc">*</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>src<span class="sc">/</span>stan<span class="sc">/</span><span class="er">**/*</span>.exe</span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>src<span class="sc">/</span>stan<span class="sc">/</span><span class="er">**/*</span>.EXE</span></code></pre></div>
<ol start="7" style="list-style-type: decimal">
<li>For <a href="https://devguide.ropensci.org/ci.html" class="external-link">continuous integration</a> (e.g. on <a href="https://github.com/r-lib/actions" class="external-link">GitHub Actions</a>), please use <a href="https://mc-stan.org/cmdstanr/" class="external-link"><code>cmdstanr</code></a>-based installation as explained above, and tweak your workflow YAML files as explained in that section.</li>
<li>For general information on R package development, please consult the free online book <a href="https://r-pkgs.org/" class="external-link">R Packages (2e)</a> by <a href="https://github.com/hadley" class="external-link">Hadley Wickham</a> and <a href="https://github.com/jennybc" class="external-link">Jennifer Bryan</a>, as well as the official manual on <a href="https://cran.r-project.org/doc/manuals/R-exts.html" class="external-link">Writing R Extensions</a> by the R Core Team.</li>
</ol>
</div>
</div>
<div class="section level1">
<h1 id="code-of-conduct">Code of Conduct<a class="anchor" aria-label="anchor" href="#code-of-conduct"></a>
</h1>
<p>Please note that the <code>instantiate</code> project is released with a <a href="https://github.com/wlandau/instantiate/blob/main/CODE_OF_CONDUCT.md" class="external-link">Contributor Code of Conduct</a>. By contributing to this project, you agree to abide by its terms.</p>
</div>
<div class="section level1">
<h1 id="citation">Citation<a class="anchor" aria-label="anchor" href="#citation"></a>
</h1>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>To cite package ‘instantiate’ <span class="cf">in</span> publications use<span class="sc">:</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>  Landau <span class="fu">WM</span> (<span class="dv">2023</span>). _instantiate<span class="sc">:</span> A Minimal CmdStan Client <span class="cf">for</span> R Packages_.</span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>  https<span class="sc">:</span><span class="er">//</span>wlandau.github.io<span class="sc">/</span>instantiate<span class="sc">/</span>, https<span class="sc">:</span><span class="er">//</span>github.com<span class="sc">/</span>wlandau<span class="sc">/</span>instantiate.</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>A BibTeX entry <span class="cf">for</span> LaTeX users is</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>  <span class="sc">@</span>Manual{,</span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>    title <span class="ot">=</span> {instantiate<span class="sc">:</span> A Minimal CmdStan Client <span class="cf">for</span> R Packages},</span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>    author <span class="ot">=</span> {William Michael Landau},</span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>    year <span class="ot">=</span> {<span class="dv">2023</span>},</span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a>    note <span class="ot">=</span> {https<span class="sc">:</span><span class="er">//</span>wlandau.github.io<span class="sc">/</span>instantiate<span class="sc">/</span>,</span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a>https<span class="sc">:</span><span class="er">//</span>github.com<span class="sc">/</span>wlandau<span class="sc">/</span>instantiate},</span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a>  }</span></code></pre></div>
</div>

  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://cloud.r-project.org/package=instantiate" class="external-link">View on CRAN</a></li>
<li><a href="https://github.com/wlandau/instantiate/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/wlandau/instantiate/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php" class="external-link">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>

<div class="community">
<h2 data-toc-skip>Community</h2>
<ul class="list-unstyled">
<li><a href="CONTRIBUTING.html">Contributing guide</a></li>
<li><a href="CODE_OF_CONDUCT.html">Code of conduct</a></li>
</ul>
</div>

<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing instantiate</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>William Michael Landau <br><small class="roles"> Author, maintainer </small> <a href="https://orcid.org/0000-0003-1878-3253" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a>  </li>
<li> Eli Lilly and Company <br><small class="roles"> Copyright holder, funder </small>   </li>
</ul>
</div>



  </div>
</div>


      <footer><div class="copyright">
  <p></p>
<p>Developed by William Michael Landau, Eli Lilly and Company.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

      </footer>
</div>






  </body>
</html>
